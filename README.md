# ORM

[![Documentation][godoc-img]][godoc-url]
![License][license-img]
[![Build Status][action-img]][action-url]
[![Coverage][codecov-img]][codecov-url]
[![Go Report Card][report-img]][report-url]

*Golang Query Executor and Database Connector*

[![ORM][orm-img]][orm-url]

## Overview

ORM is a package that facilitates execution of [loukoum][loukoum-url] queries
as well as migrations and scripts generate by [prana][prana-url].

## Installation

```console
$ go get -u github.com/phogolabs/orm
```

## Introduction

Note that ORM is in BETA. We may introduce breaking changes until we reach
v1.0.

Gateway API facilitates object relation mapping and query building by using
[loukoum](loukoum-url) and [sqlx][sqlx-url].

Let's first import all required packages:

```golang
import (
  lk "github.com/ulule/loukoum"
  "github.com/phogolabs/orm"
)
```

and then establish the connection:

```golang
gateway, err := orm.Open("sqlite3", "example.db")
if err != nil {
 return err
}
```

### SQL Queries

All [loukoum][loukoum-url] queries are complaint with `orm.Query` interface:

```golang
// Query returns the underlying query
type Query interface {
	// Query prepares the query
	Query() (string, []Param)
}

// NamedQuery returns the underlying query
type NamedQuery interface {
	// Query prepares the query
	NamedQuery() (string, map[string]Param)
}
```

That allows easy execution of all kind of queries.

Because the package is empowered by [sqlx][sqlx-url]. It can perform field
mapping of Golang structs by reading a `db` field tag. Let's assume that we
have the following struct:

```golang
// Package model contains an object model of database schema 'default'
// Auto-generated at Thu Apr 19 21:36:35 CEST 2018
package model

import null "gopkg.in/volatiletech/null.v6"

// User represents a data base table 'users'
type User struct {
	// ID represents a database column 'id' of type 'INT PRIMARY KEY NOT NULL'
	ID int `db:"id,primary_key,not_null" json:"id" xml:"id" validate:"required"`

	// FirstName represents a database column 'first_name' of type 'TEXT NOT NULL'
	FirstName string `db:"first_name,not_null" json:"first_name" xml:"first_name" validate:"required"`

	// LastName represents a database column 'last_name' of type 'TEXT NULL'
	LastName null.String `db:"last_name,null" json:"last_name" xml:"last_name" validate:"-"`
}
```

#### Insert a new record

```golang

query := lk.Insert("users").
	Set(
		lk.Pair("first_name", "John"),
		lk.Pair("last_name", "Doe"),
	)

if _, err := gateway.Exec(query); err != nil {
  return err
}
```

#### Select all records

```golang
query := lk.Select("id", "first_name", "last_name").From("users")
users := []User{}

if err := gateway.Select(&users, query); err != nil {
  return err
}
```

#### Select a record

```golang
query := lk.Select("id", "first_name", "last_name").
	From("users").
	Where(lk.Condition("first_name").Equal("John"))

user := User{}

if err := gateway.SelectOne(&user, query); err != nil {
  return err
}
```

You can read more details about [loukoum][loukoum-url] on their repository.

#### RQL Support

The package support [RQL](https://github.com/a8m/rql) queries. RQL provides a
simple and light-weight API for adding dynamic querying capabilities to
web-applications that use SQL-based database.

Let's have the following query that is received via HTTP:

```json
{
  "$or": [
    { "city": "TLV" },
    { "zip": { "$gte": 49800, "$lte": 57080 } }
  ]
}
```

Then we can process it in the following way:

```golang
param := &orm.RQLQuery{}

err := json.Unmarshal(body, param)
if err != nil {
  panic(err)
}

rows, err := gateway.Query(orm.RQL("addresses", param))
```

### SQL Migrations with Prana

You can execute the migration generated by [Prana][prana-url]. First, you
should load the migration directory by using [Parcello][parcello-url]. You can
load it from embedded resource or from the local directory:

```golang
if err := gateway.Migrate(parcello.Dir("./database/migration")); err != nil {
	return err
}
```

### SQL Scripts and Routines with Prana

ORM provides a way to work with embeddable SQL scripts. It can understand
[SQL Scripts](https://github.com/phogolabs/prana#sql-scripts-and-commands) from
file and execute them as standard SQL queries. Let's assume that we have SQL
query named `show-sqlite-master`.

Let's first load the SQL script from file:

```
-- name: show-sqlite-master
SELECT * FROM sqlite_master;

-- named: show-table
SELECT * FROM {{table}};
```

```golang
if err = gateway.ReadFrom(file); err != nil {
  log.WithError(err).Fatal("Failed to load script")
}
```

Then you can execute the desired script by just passing its name:

```golang
_, err = gateway.Exec(orm.Routine("show-sqlite-master"))
```

Also you can Raw SQL Scripts from your code, you should follow this
example:

```golang
rows, err := gateway.Query(orm.SQL("SELECT * FROM users WHERE id = ?", 5432))
```

Also you can use [handlerbars](https://handlebarsjs.com) to template your
query. But be aware how you use it in order not to open possible SQL
injections:

```golang
param := orm.Map{
  "table": "users",
}

_, err = gateway.Exec(orm.Routine("show-table", param))
```

### Example

You can check our [Getting Started Example](/example).

For more information, how you can change the default behavior you can read the
help documentation by executing:

## Contributing

We are open for any contributions. Just fork the
[project](https://github.com/phogolabs/orm).

*logo made by [Free Pik][logo-author-url]*

[report-img]: https://goreportcard.com/badge/github.com/phogolabs/orm
[report-url]: https://goreportcard.com/report/github.com/phogolabs/orm
[logo-author-url]: https://www.freepik.com/free-photos-vectors/tree
[logo-license]: http://creativecommons.org/licenses/by/3.0/
[orm-url]: https://github.com/phogolabs/orm
[orm-img]: doc/img/logo.png
[codecov-url]: https://codecov.io/gh/phogolabs/orm
[codecov-img]: https://codecov.io/gh/phogolabs/orm/branch/master/graph/badge.svg
[action-img]: https://github.com/phogolabs/orm/workflows/main/badge.svg
[action-url]: https://github.com/phogolabs/orm/actions
[orm-url]: https://github.com/phogolabs/orm
[godoc-url]: https://godoc.org/github.com/phogolabs/orm
[godoc-img]: https://godoc.org/github.com/phogolabs/orm?status.svg
[license-img]: https://img.shields.io/badge/license-MIT-blue.svg
[software-license-url]: LICENSE
[loukoum-url]: https://github.com/ulule/loukoum
[parcello-url]: https://github.com/phogolabs/parcello
[prana-url]: https://github.com/phogolabs/prana
[sqlx-url]: https://github.com/jmoiron/sqlx
